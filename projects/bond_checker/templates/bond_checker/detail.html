{% extends 'bond_checker/base.html' %}

{% block title %}{{ bond_doc.file_name }} - 詳細{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{% url 'bond_checker:index' %}" class="btn btn-outline-secondary">
        ← ホームに戻る
    </a>
</div>

<div class="upload-area">
    <h2 class="mb-4">ドキュメント詳細</h2>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <h5>ファイル情報</h5>
            <table class="table table-borderless">
                <tr>
                    <th width="120">ファイル名:</th>
                    <td>{{ bond_doc.file_name }}</td>
                </tr>
                <tr>
                    <th>ファイルタイプ:</th>
                    <td>
                        {% if bond_doc.file_type == 'pdf' %}
                            PDF
                        {% else %}
                            画像
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>アップロード日時:</th>
                    <td>{{ bond_doc.uploaded_at|date:"Y年m月d日 H:i:s" }}</td>
                </tr>
                <tr>
                    <th>解析状況:</th>
                    <td>
                        {% if bond_doc.analysis_status == 'completed' %}
                            <span class="status-badge status-completed">完了</span>
                        {% elif bond_doc.analysis_status == 'processing' %}
                            <span class="status-badge status-processing">処理中</span>
                        {% elif bond_doc.analysis_status == 'failed' %}
                            <span class="status-badge status-failed">失敗</span>
                        {% else %}
                            <span class="status-badge status-pending">待機中</span>
                        {% endif %}
                    </td>
                </tr>
                {% if bond_doc.analyzed_at %}
                <tr>
                    <th>解析完了日時:</th>
                    <td>{{ bond_doc.analyzed_at|date:"Y年m月d日 H:i:s" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        <div class="col-md-6">
            <h5>指示プロンプト</h5>
            <div class="card">
                <div class="card-body">
                    <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 200px; overflow-y: auto; margin: 0; font-size: 0.85rem;">{{ bond_doc.instruction_prompt }}</pre>
                </div>
            </div>
        </div>
    </div>

    {% if bond_doc.analysis_status == 'completed' %}
    
    <!-- 処理時間の比較 -->
    <div class="mt-4">
        <h5>処理時間の比較</h5>
        <div class="row">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 style="font-size: 0.9rem;">{% if bond_doc.file_type == 'pdf' %}pdfplumber{% else %}Tesseract OCR{% endif %}</h6>
                        {% if bond_doc.ocr_processing_time %}
                            <h4 class="text-primary">{{ bond_doc.ocr_processing_time|floatformat:2 }}秒</h4>
                            <span class="status-badge status-{{ bond_doc.ocr_status }}">{{ bond_doc.ocr_status }}</span>
                        {% else %}
                            <p class="text-muted">未実行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 style="font-size: 0.9rem;">GPT-4o</h6>
                        {% if bond_doc.gpt4o_processing_time %}
                            <h4 class="text-info">{{ bond_doc.gpt4o_processing_time|floatformat:2 }}秒</h4>
                            <span class="status-badge status-{{ bond_doc.gpt4o_status }}">{{ bond_doc.gpt4o_status }}</span>
                        {% else %}
                            <p class="text-muted">未実行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 style="font-size: 0.9rem;">GPT-4-turbo</h6>
                        {% if bond_doc.gpt35_processing_time %}
                            <h4 class="text-info">{{ bond_doc.gpt35_processing_time|floatformat:2 }}秒</h4>
                            <span class="status-badge status-{{ bond_doc.gpt35_status }}">{{ bond_doc.gpt35_status }}</span>
                        {% else %}
                            <p class="text-muted">未実行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 style="font-size: 0.9rem;">Gemini 2.0 Flash Exp</h6>
                        {% if bond_doc.gemini_processing_time %}
                            <h4 class="text-success">{{ bond_doc.gemini_processing_time|floatformat:2 }}秒</h4>
                            <span class="status-badge status-{{ bond_doc.gemini_status }}">{{ bond_doc.gemini_status }}</span>
                        {% else %}
                            <p class="text-muted">未実行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 style="font-size: 0.9rem;">Claude 3 Opus</h6>
                        {% if bond_doc.claude_processing_time %}
                            <h4 class="text-warning">{{ bond_doc.claude_processing_time|floatformat:2 }}秒</h4>
                            <span class="status-badge status-{{ bond_doc.claude_status }}">{{ bond_doc.claude_status }}</span>
                        {% else %}
                            <p class="text-muted">未実行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- タブで切り替え可能な結果表示 -->
    <div class="mt-4">
        <h5>認識結果の比較</h5>
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ocr-tab" data-bs-toggle="tab" data-bs-target="#ocr" type="button" role="tab">
                    {% if bond_doc.file_type == 'pdf' %}pdfplumber{% else %}Tesseract OCR{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gpt4o-tab" data-bs-toggle="tab" data-bs-target="#gpt4o" type="button" role="tab">
                    GPT-4o
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gpt35-tab" data-bs-toggle="tab" data-bs-target="#gpt35" type="button" role="tab">
                    GPT-4-turbo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gemini-tab" data-bs-toggle="tab" data-bs-target="#gemini" type="button" role="tab">
                    Gemini 2.0 Flash Exp
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="claude-tab" data-bs-toggle="tab" data-bs-target="#claude" type="button" role="tab">
                    Claude 3 Opus
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab">
                    比較分析
                </button>
            </li>
        </ul>
        <div class="tab-content mt-3" id="resultTabsContent">
            <!-- OCR結果 -->
            <div class="tab-pane fade show active" id="ocr" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">{% if bond_doc.file_type == 'pdf' %}pdfplumber{% else %}Tesseract OCR{% endif %} 抽出結果</h6>
                    </div>
                    <div class="card-body">
                        {% if bond_doc.ocr_result %}
                            <div class="mb-2">
                                <strong>文字数:</strong> {{ bond_doc.ocr_result|length }} 文字
                            </div>
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 500px; overflow-y: auto;">{{ bond_doc.ocr_result }}</pre>
                        {% elif bond_doc.ocr_error %}
                            <div class="alert alert-danger">
                                エラー: {{ bond_doc.ocr_error }}
                            </div>
                        {% else %}
                            <p class="text-muted">結果がありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- GPT-4o結果 -->
            <div class="tab-pane fade" id="gpt4o" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">GPT-4o 解析結果</h6>
                    </div>
                    <div class="card-body">
                        {% if bond_doc.gpt4o_result %}
                            <div class="mb-2">
                                <strong>文字数:</strong> {{ bond_doc.gpt4o_result|length }} 文字
                            </div>
                            {% if bond_doc.gpt4o_accuracy %}
                            <div class="mb-2">
                                <strong>適合率:</strong> 
                                <span class="{% if bond_doc.gpt4o_accuracy >= 80 %}text-success{% elif bond_doc.gpt4o_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ bond_doc.gpt4o_accuracy }}%
                                </span>
                            </div>
                            {% endif %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 500px; overflow-y: auto;">{{ bond_doc.gpt4o_result }}</pre>
                        {% elif bond_doc.gpt4o_status == 'failed' %}
                            <div class="alert alert-danger">
                                エラー: GPT-4oの解析に失敗しました
                            </div>
                        {% else %}
                            <p class="text-muted">結果がありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- GPT-4-turbo結果 -->
            <div class="tab-pane fade" id="gpt35" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">GPT-4-turbo 解析結果</h6>
                    </div>
                    <div class="card-body">
                        {% if bond_doc.gpt35_result %}
                            <div class="mb-2">
                                <strong>文字数:</strong> {{ bond_doc.gpt35_result|length }} 文字
                            </div>
                            {% if bond_doc.gpt35_accuracy %}
                            <div class="mb-2">
                                <strong>適合率:</strong> 
                                <span class="{% if bond_doc.gpt35_accuracy >= 80 %}text-success{% elif bond_doc.gpt35_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ bond_doc.gpt35_accuracy }}%
                                </span>
                            </div>
                            {% endif %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 500px; overflow-y: auto;">{{ bond_doc.gpt35_result }}</pre>
                        {% elif bond_doc.gpt35_status == 'failed' %}
                            <div class="alert alert-danger">
                                エラー: GPT-4-turboの解析に失敗しました
                            </div>
                        {% else %}
                            <p class="text-muted">結果がありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Gemini結果 -->
            <div class="tab-pane fade" id="gemini" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Gemini 2.0 Flash Exp 解析結果</h6>
                    </div>
                    <div class="card-body">
                        {% if bond_doc.gemini_result %}
                            <div class="mb-2">
                                <strong>文字数:</strong> {{ bond_doc.gemini_result|length }} 文字
                            </div>
                            {% if bond_doc.gemini_accuracy %}
                            <div class="mb-2">
                                <strong>適合率:</strong> 
                                <span class="{% if bond_doc.gemini_accuracy >= 80 %}text-success{% elif bond_doc.gemini_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ bond_doc.gemini_accuracy }}%
                                </span>
                            </div>
                            {% endif %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 500px; overflow-y: auto;">{{ bond_doc.gemini_result }}</pre>
                        {% elif bond_doc.gemini_status == 'failed' %}
                            <div class="alert alert-danger">
                                エラー: {{ bond_doc.gemini_result }}
                            </div>
                        {% else %}
                            <p class="text-muted">結果がありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Claude結果 -->
            <div class="tab-pane fade" id="claude" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Claude 3 Opus 解析結果</h6>
                    </div>
                    <div class="card-body">
                        {% if bond_doc.claude_result %}
                            <div class="mb-2">
                                <strong>文字数:</strong> {{ bond_doc.claude_result|length }} 文字
                            </div>
                            {% if bond_doc.claude_accuracy %}
                            <div class="mb-2">
                                <strong>適合率:</strong> 
                                <span class="{% if bond_doc.claude_accuracy >= 80 %}text-success{% elif bond_doc.claude_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ bond_doc.claude_accuracy }}%
                                </span>
                            </div>
                            {% endif %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 500px; overflow-y: auto;">{{ bond_doc.claude_result }}</pre>
                        {% elif bond_doc.claude_status == 'failed' %}
                            <div class="alert alert-danger">
                                エラー: {{ bond_doc.claude_result }}
                            </div>
                        {% else %}
                            <p class="text-muted">結果がありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 比較分析 -->
            <div class="tab-pane fade" id="comparison" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">精度比較分析（5つのツール/モデル）</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>項目</th>
                                    <th>{% if bond_doc.file_type == 'pdf' %}pdfplumber{% else %}Tesseract OCR{% endif %}</th>
                                    <th>GPT-4o</th>
                                    <th>GPT-4-turbo</th>
                                    <th>Gemini 2.0 Flash Exp</th>
                                    <th>Claude 3 Opus</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ステータス</strong></td>
                                    <td><span class="status-badge status-{{ bond_doc.ocr_status }}">{{ bond_doc.ocr_status }}</span></td>
                                    <td><span class="status-badge status-{{ bond_doc.gpt4o_status }}">{{ bond_doc.gpt4o_status }}</span></td>
                                    <td><span class="status-badge status-{{ bond_doc.gpt35_status }}">{{ bond_doc.gpt35_status }}</span></td>
                                    <td><span class="status-badge status-{{ bond_doc.gemini_status }}">{{ bond_doc.gemini_status }}</span></td>
                                    <td><span class="status-badge status-{{ bond_doc.claude_status }}">{{ bond_doc.claude_status }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>処理時間</strong></td>
                                    <td>{{ bond_doc.ocr_processing_time|floatformat:2|default:"-" }} 秒</td>
                                    <td>{{ bond_doc.gpt4o_processing_time|floatformat:2|default:"-" }} 秒</td>
                                    <td>{{ bond_doc.gpt35_processing_time|floatformat:2|default:"-" }} 秒</td>
                                    <td>{{ bond_doc.gemini_processing_time|floatformat:2|default:"-" }} 秒</td>
                                    <td>{{ bond_doc.claude_processing_time|floatformat:2|default:"-" }} 秒</td>
                                </tr>
                                <tr>
                                    <td><strong>抽出文字数</strong></td>
                                    <td>{{ bond_doc.ocr_result|length|default:"0" }} 文字</td>
                                    <td>{{ bond_doc.gpt4o_result|length|default:"0" }} 文字</td>
                                    <td>{{ bond_doc.gpt35_result|length|default:"0" }} 文字</td>
                                    <td>{{ bond_doc.gemini_result|length|default:"0" }} 文字</td>
                                    <td>{{ bond_doc.claude_result|length|default:"0" }} 文字</td>
                                </tr>
                                {% if bond_doc.correct_text %}
                                <tr>
                                    <td><strong>適合率</strong></td>
                                    <td>
                                        {% if bond_doc.ocr_accuracy %}
                                            <h5 class="mb-0 {% if bond_doc.ocr_accuracy >= 80 %}text-success{% elif bond_doc.ocr_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.ocr_accuracy }}%
                                            </h5>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bond_doc.gpt4o_accuracy %}
                                            <h5 class="mb-0 {% if bond_doc.gpt4o_accuracy >= 80 %}text-success{% elif bond_doc.gpt4o_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gpt4o_accuracy }}%
                                            </h5>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bond_doc.gpt35_accuracy %}
                                            <h5 class="mb-0 {% if bond_doc.gpt35_accuracy >= 80 %}text-success{% elif bond_doc.gpt35_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gpt35_accuracy }}%
                                            </h5>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bond_doc.gemini_accuracy %}
                                            <h5 class="mb-0 {% if bond_doc.gemini_accuracy >= 80 %}text-success{% elif bond_doc.gemini_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gemini_accuracy }}%
                                            </h5>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bond_doc.claude_accuracy %}
                                            <h5 class="mb-0 {% if bond_doc.claude_accuracy >= 80 %}text-success{% elif bond_doc.claude_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.claude_accuracy }}%
                                            </h5>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        
                        {% if bond_doc.correct_text %}
                        <div class="alert alert-success mt-3">
                            <h6>正解テキストと比較した適合率</h6>
                            <div class="row mt-3">
                                <div class="col">
                                    <div class="text-center">
                                        <p class="mb-1"><strong>{% if bond_doc.file_type == 'pdf' %}pdfplumber{% else %}OCR{% endif %}</strong></p>
                                        {% if bond_doc.ocr_accuracy %}
                                            <h4 class="{% if bond_doc.ocr_accuracy >= 80 %}text-success{% elif bond_doc.ocr_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.ocr_accuracy }}%
                                            </h4>
                                        {% else %}
                                            <p class="text-muted">-</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="text-center">
                                        <p class="mb-1"><strong>GPT-4o</strong></p>
                                        {% if bond_doc.gpt4o_accuracy %}
                                            <h4 class="{% if bond_doc.gpt4o_accuracy >= 80 %}text-success{% elif bond_doc.gpt4o_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gpt4o_accuracy }}%
                                            </h4>
                                        {% else %}
                                            <p class="text-muted">-</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="text-center">
                                        <p class="mb-1"><strong>GPT-4-turbo</strong></p>
                                        {% if bond_doc.gpt35_accuracy %}
                                            <h4 class="{% if bond_doc.gpt35_accuracy >= 80 %}text-success{% elif bond_doc.gpt35_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gpt35_accuracy }}%
                                            </h4>
                                        {% else %}
                                            <p class="text-muted">-</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="text-center">
                                        <p class="mb-1"><strong>Gemini 2.0 Flash Exp</strong></p>
                                        {% if bond_doc.gemini_accuracy %}
                                            <h4 class="{% if bond_doc.gemini_accuracy >= 80 %}text-success{% elif bond_doc.gemini_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.gemini_accuracy }}%
                                            </h4>
                                        {% else %}
                                            <p class="text-muted">-</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="text-center">
                                        <p class="mb-1"><strong>Claude 3 Opus</strong></p>
                                        {% if bond_doc.claude_accuracy %}
                                            <h4 class="{% if bond_doc.claude_accuracy >= 80 %}text-success{% elif bond_doc.claude_accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ bond_doc.claude_accuracy }}%
                                            </h4>
                                        {% else %}
                                            <p class="text-muted">-</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <p class="mb-0"><strong>正解テキスト:</strong></p>
                            <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 150px; overflow-y: auto; background-color: #1a1a1a; padding: 10px; border-radius: 5px;">{{ bond_doc.correct_text }}</pre>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info mt-3">
                            <h6>精度評価のポイント</h6>
                            <ul class="mb-0">
                                <li><strong>処理時間:</strong> より短い方が効率的</li>
                                <li><strong>適合率:</strong> 80%以上で良好、60%以上で普通、60%未満で要改善</li>
                                <li><strong>構造化:</strong> 生成AIは情報を整理して出力</li>
                                <li><strong>コスト:</strong> OCRは無料、生成AIはAPIコストが発生</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif bond_doc.analysis_status == 'failed' %}
    <div class="alert alert-danger mt-4">
        <h5>エラーが発生しました</h5>
        <p class="mb-0">{{ bond_doc.error_message }}</p>
    </div>
    {% elif bond_doc.analysis_status == 'processing' %}
    <div class="alert alert-info mt-4">
        <h5>処理中</h5>
        <p class="mb-0">ファイルを解析しています。しばらくお待ちください...</p>
    </div>
    {% endif %}
</div>
{% endblock %}
